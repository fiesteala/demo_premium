<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boda de Sofía y Alejandro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. LÓGICA DE CONFIGURACIÓN DINÁMICA
        const storedConfig = localStorage.getItem('custom_firebase_config');
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const demoConfig = { apiKey: "demo", authDomain: "demo", projectId: "demo" };
        
        const firebaseConfig = storedConfig ? JSON.parse(storedConfig) : (envConfig || demoConfig);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        let initError = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            initError = e.message;
        }

        // Exportar a global
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.appId = appId;
        window.auth = auth;
        window.query = query;
        window.orderBy = orderBy;
        window.signInAnonymously = signInAnonymously;
        window.isAuthReady = false;

        // Función de conexión robusta
        const initAuth = async () => {
            if (initError) {
                updateStatus("Error de Configuración", "red");
                return;
            }

            console.log("Iniciando conexión...");
            updateStatus("Conectando...", "yellow");
            
            try {
                if (firebaseConfig.apiKey === "demo") {
                    updateStatus("Modo Demo (Sin Nube)", "gray");
                    return;
                }

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error Auth:", error);
                updateStatus("Error de Conexión", "red");
                setTimeout(() => signInAnonymously(auth).catch(() => {}), 3000);
            }
        };

        // Iniciar
        if(auth) {
            initAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Conectado a la nube. ID:", user.uid);
                    window.isAuthReady = true;
                    updateStatus("Conectado a la Nube", "green");
                } else {
                    window.isAuthReady = false;
                    const currentStatus = document.getElementById('connectionStatusText')?.innerText;
                    if (currentStatus !== "Error de Conexión") {
                        updateStatus("Desconectado", "red");
                    }
                }
            });
        }

        function updateStatus(text, color) {
            const el = document.getElementById('connectionStatusText');
            if(el) {
                el.innerText = text;
                let colorClass = 'text-gray-400'; // Default gray for modal
                if(color === 'green') colorClass = 'text-green-600 font-bold';
                if(color === 'red') colorClass = 'text-red-500 font-bold';
                if(color === 'yellow') colorClass = 'text-yellow-600';
                el.className = `text-xs ${colorClass} transition-colors duration-300 mt-2 block`;
            }
        }
        
        window.saveCustomConfig = (jsonString) => {
            try {
                // AUTO-CORRECCIÓN DE FORMATO:
                // 1. Limpiar espacios raros (non-breaking spaces) que a veces vienen al copiar
                let cleanString = jsonString.replace(/[\u00A0\u200B]/g, ' ').trim();
                
                // 2. Si las claves no tienen comillas (ej: apiKey: "..."), se las ponemos.
                // Apuntamos específicamente a las claves conocidas de Firebase para no romper URLs
                cleanString = cleanString.replace(/(apiKey|authDomain|projectId|storageBucket|messagingSenderId|appId|measurementId)\s*:/g, '"$1":');
                
                // 3. Convertir comillas simples a dobles si las hubiera
                cleanString = cleanString.replace(/'/g, '"');
                
                // 4. Quitar coma final si existe (trailing comma) antes de cerrar llave
                cleanString = cleanString.replace(/,(\s*})/g, '$1');

                const conf = JSON.parse(cleanString);
                
                if(!conf.apiKey) throw new Error("Falta apiKey");
                
                // Guardamos la versión corregida y válida
                localStorage.setItem('custom_firebase_config', JSON.stringify(conf));
                alert("¡Configuración guardada y corregida! La página se recargará ahora.");
                window.location.reload();
            } catch(e) {
                console.error(e);
                alert("No se pudo leer la configuración. Por favor asegúrate de copiar TODO el bloque, incluyendo las llaves { y } del principio y final.");
            }
        }
        
        window.clearCustomConfig = () => {
            if(confirm("¿Restaurar configuración original?")) {
                localStorage.removeItem('custom_firebase_config');
                window.location.reload();
            }
        }
    </script>

    <style>
        :root {
            --gold: #D4AF37;
            --cream: #F9F7F2;
            --dark: #2C2C2C;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--cream);
            color: var(--dark);
            overflow-x: hidden;
        }
        h1, h2, .script-font { font-family: 'Great Vibes', cursive; }
        .music-pulse { animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }
        .parallax {
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 1s ease-out;
        }
        .reveal.active { opacity: 1; transform: translateY(0); }
        #lightbox { backdrop-filter: blur(10px); }
        
        /* Estilos Ticket */
        .ticket-bg {
            background: radial-gradient(circle at top left, transparent 20px, white 21px), 
                        radial-gradient(circle at top right, transparent 20px, white 21px), 
                        radial-gradient(circle at bottom left, transparent 20px, white 21px), 
                        radial-gradient(circle at bottom right, transparent 20px, white 21px);
            background-color: white;
            filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.1));
        }
        #adminPanel { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased relative">

    <audio id="weddingMusic" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <!-- Botón Música -->
    <div class="fixed top-5 right-5 z-40">
        <button id="musicBtn" onclick="toggleMusic()" class="bg-white text-yellow-600 w-12 h-12 rounded-full shadow-lg flex items-center justify-center focus:outline-none transition-all duration-300 music-pulse border border-yellow-200">
            <i class="fas fa-music" id="musicIcon"></i>
        </button>
    </div>

    <main id="guestView">
        <!-- HERO -->
        <header class="relative h-screen flex flex-col justify-center items-center text-center parallax" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1519741497674-611481863552?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
            <div class="animate__animated animate__fadeInDown">
                <p class="text-white text-lg tracking-[0.3em] uppercase mb-4">¡Nos Casamos!</p>
                <h1 class="text-6xl md:text-8xl text-white mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Sofía & Alejandro</h1>
            </div>
            <div class="mt-8 animate__animated animate__fadeInUp animate__delay-1s">
                <div class="inline-block border-t border-b border-white py-2 px-6">
                    <p class="text-2xl text-white font-light">15 . OCT . 2026</p>
                </div>
            </div>
            <div class="absolute bottom-10 animate__animated animate__bounce animate__infinite">
                <i class="fas fa-chevron-down text-white text-2xl"></i>
            </div>
        </header>

        <!-- TICKET PERSONALIZADO -->
        <section id="personalTicket" class="hidden py-12 bg-yellow-50">
            <div class="container mx-auto px-4">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl border-2 border-yellow-500 relative overflow-hidden animate__animated animate__flipInX">
                    <div class="absolute top-0 left-0 w-full h-2 bg-yellow-500"></div>
                    <div class="absolute bottom-0 left-0 w-full h-2 bg-yellow-500"></div>
                    <div class="text-center">
                        <span class="text-xs uppercase tracking-widest text-gray-500 mb-2 block">Pase de Entrada Personal</span>
                        <h2 class="text-3xl script-font text-yellow-600 mb-4">Invitación Especial</h2>
                        <div class="my-6 border-t border-b border-gray-100 py-4">
                            <p class="text-gray-600 italic mb-2">Para:</p>
                            <h3 id="guestNameDisplay" class="text-2xl font-bold text-gray-800 uppercase">Familia Pérez</h3>
                        </div>
                        <div class="flex justify-center items-center gap-4">
                            <div class="text-center">
                                <i class="fas fa-users text-3xl text-yellow-500 mb-2"></i>
                                <p class="text-sm text-gray-500 uppercase">Reservados</p>
                                <p class="text-2xl font-bold text-gray-800"><span id="guestCountDisplay">2</span> Lugares</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-6">* Presentar este pase en la entrada</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- FRASE -->
        <section class="py-16 px-6 text-center bg-white">
            <div class="max-w-2xl mx-auto reveal">
                <i class="fas fa-quote-left text-yellow-500 text-2xl mb-4"></i>
                <p class="text-xl md:text-2xl italic text-gray-600 font-light leading-relaxed">"El amor no consiste en mirarse el uno al otro, sino en mirar juntos en la misma dirección."</p>
                <p class="mt-4 text-sm text-gray-400 uppercase tracking-widest">- Antoine de Saint-Exupéry</p>
                <hr class="w-24 border-yellow-500 mx-auto mt-8">
            </div>
        </section>

        <!-- CUENTA REGRESIVA -->
        <section class="py-20 bg-cover bg-center relative text-white parallax" style="background-image: url('https://images.unsplash.com/photo-1519225448526-06456f5ad695?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
            <div class="container mx-auto relative z-10 text-center reveal">
                <h2 class="text-4xl md:text-5xl mb-8 font-script" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">¡Falta muy poco!</h2>
                <div class="flex justify-center gap-4 md:gap-8" id="countdown"></div>
            </div>
        </section>

        <!-- DETALLES -->
        <section class="py-20 container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-5xl mx-auto">
                <div class="text-center bg-white p-8 rounded-lg shadow-xl border border-gray-100 reveal hover:-translate-y-2 transition duration-300">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-church text-2xl text-yellow-600"></i>
                    </div>
                    <h3 class="text-2xl font-semibold mb-2">Ceremonia Religiosa</h3>
                    <p class="text-gray-500 mb-4">16:00 HRS</p>
                    <p class="text-gray-700 font-medium mb-1">Catedral Metropolitana</p>
                    <a href="#" class="inline-block px-6 py-2 border border-yellow-600 text-yellow-600 rounded-full hover:bg-yellow-600 hover:text-white transition duration-300 text-sm uppercase tracking-wide mt-4">Ver Mapa</a>
                </div>
                <div class="text-center bg-white p-8 rounded-lg shadow-xl border border-gray-100 reveal hover:-translate-y-2 transition duration-300">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-glass-cheers text-2xl text-yellow-600"></i>
                    </div>
                    <h3 class="text-2xl font-semibold mb-2">Recepción</h3>
                    <p class="text-gray-500 mb-4">19:00 HRS</p>
                    <p class="text-gray-700 font-medium mb-1">Hacienda Los Arcángeles</p>
                    <a href="#" class="inline-block px-6 py-2 border border-yellow-600 text-yellow-600 rounded-full hover:bg-yellow-600 hover:text-white transition duration-300 text-sm uppercase tracking-wide mt-4">Cómo llegar</a>
                </div>
            </div>
            <div class="text-center mt-12 reveal">
                <button onclick="addToCalendar()" class="bg-yellow-600 text-white px-8 py-4 rounded-full shadow-lg hover:bg-yellow-700 transition duration-300 flex items-center justify-center mx-auto gap-3 text-lg">
                    <i class="far fa-calendar-alt"></i> Agendar en Google Calendar
                </button>
            </div>
        </section>

        <!-- GALERÍA -->
        <section class="py-20 bg-white">
            <div class="text-center mb-10 reveal">
                <span class="text-yellow-600 text-sm font-bold uppercase tracking-widest">Nuestra Historia</span>
                <h2 class="text-5xl script-font text-gray-800">Momentos Inolvidables</h2>
            </div>
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 auto-rows-[200px]">
                    <div class="col-span-2 row-span-2 rounded-xl overflow-hidden cursor-pointer group relative reveal" onclick="openLightbox('https://images.unsplash.com/photo-1583939003579-730e3918a45a?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80')">
                        <img src="https://images.unsplash.com/photo-1583939003579-730e3918a45a?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    </div>
                    <div class="rounded-xl overflow-hidden cursor-pointer group relative reveal" onclick="openLightbox('https://images.unsplash.com/photo-1519225448526-06456f5ad695?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80')">
                        <img src="https://images.unsplash.com/photo-1519225448526-06456f5ad695?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    </div>
                    <div class="rounded-xl overflow-hidden cursor-pointer group relative reveal" onclick="openLightbox('https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80')">
                        <img src="https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    </div>
                    <div class="col-span-2 rounded-xl overflow-hidden cursor-pointer group relative reveal" onclick="openLightbox('https://images.unsplash.com/photo-1511285560982-1351cdeb9821?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80')">
                        <img src="https://images.unsplash.com/photo-1511285560982-1351cdeb9821?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    </div>
                </div>
            </div>
        </section>

        <!-- FOOTER -->
        <footer class="bg-white pt-10 pb-20 border-t border-gray-200">
            <div class="container mx-auto px-4 text-center reveal">
                <h2 class="text-4xl script-font text-gray-800 mb-2">Confirmación</h2>
                <p class="text-gray-500 mb-8">Esperamos contar con tu presencia.</p>
                <button onclick="sendWhatsapp()" class="bg-[#25D366] text-white px-8 py-4 rounded-full shadow-lg hover:bg-[#20bd5a] transition duration-300 flex items-center justify-center mx-auto gap-3 text-lg w-full max-w-sm">
                    <i class="fab fa-whatsapp text-2xl"></i> Confirmar Asistencia
                </button>
                <div class="mt-12 text-sm text-gray-400 flex flex-col items-center gap-2">
                    <p>Sofía & Alejandro | 2026</p>
                    <button onclick="openAdminLogin()" class="text-gray-300 hover:text-gray-500 text-xs mt-4 underline">Admin</button>
                    <!-- Status hidden from guests -->
                </div>
            </div>
        </footer>
    </main>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="fixed inset-0 z-50 bg-gray-100 overflow-y-auto transform translate-y-full transition-transform duration-300">
        <div class="bg-white shadow-md p-4 sticky top-0 z-10 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">Panel de Control</h2>
            <button onclick="closeAdmin()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-6xl">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8 border-l-4 border-yellow-500">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-user-plus text-yellow-500"></i> Nuevo Invitado</h3>
                <form id="addGuestForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="inputName" placeholder="Nombre completo" class="border p-3 rounded col-span-2" required>
                    <input type="number" id="inputTickets" placeholder="Pases" class="border p-3 rounded" required min="1">
                    <button type="submit" class="bg-gray-800 text-white p-3 rounded font-bold">Agregar</button>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="text-lg font-bold">Lista de Invitados</h3>
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">Exportar Excel</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-sm uppercase">
                                <th class="p-4 border-b">Nombre</th>
                                <th class="p-4 border-b text-center">Pases</th>
                                <th class="p-4 border-b">Enlace</th>
                                <th class="p-4 border-b text-center">Borrar</th>
                            </tr>
                        </thead>
                        <tbody id="guestTableBody" class="text-gray-700 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[60] hidden bg-black/90 flex items-center justify-center px-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
            <!-- Icono de Configuración -->
            <button onclick="toggleConfig()" class="absolute top-2 right-2 p-2 bg-gray-100 rounded-full text-gray-500 hover:text-yellow-600 transition shadow-sm" title="Configurar Base de Datos">
                <i class="fas fa-cog text-xl"></i>
            </button>

            <div id="loginFormContent">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Acceso Admin</h3>
                <p class="text-sm text-gray-500 mb-6">Contraseña (1234)</p>
                <input type="password" id="adminPassword" placeholder="Contraseña" class="w-full border p-3 rounded mb-4 text-center text-lg">
                <div class="flex gap-2">
                    <button onclick="document.getElementById('loginModal').classList.add('hidden')" class="flex-1 bg-gray-200 py-3 rounded">Cancelar</button>
                    <button onclick="checkLogin()" class="flex-1 bg-yellow-600 text-white py-3 rounded font-bold">Entrar</button>
                </div>
                <p id="loginStatus" class="text-xs text-red-500 mt-2 hidden">Error</p>
                <p id="connectionStatus" class="text-xs text-blue-500 mt-2 hidden">Verificando red...</p>
                <!-- Status now hidden inside here -->
                <p id="connectionStatusText" class="text-xs text-gray-400 mt-2">Conectando...</p>
            </div>

            <!-- Panel de Configuración -->
            <div id="configPanelContent" class="hidden text-left mt-4 pt-4 border-t">
                <h4 class="text-sm font-bold text-gray-700 mb-2">Configuración Firebase</h4>
                <p class="text-xs text-gray-500 mb-2">Pega aquí el código JSON de Firebase para conectar tu base de datos:</p>
                <textarea id="customConfigInput" rows="4" class="w-full border p-2 text-xs font-mono bg-gray-50 rounded mb-2" placeholder='{"apiKey": "...", "authDomain": "..."}'></textarea>
                <div class="flex gap-2">
                    <button onclick="saveCustomConfig(document.getElementById('customConfigInput').value)" class="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold">Guardar</button>
                    <button onclick="clearCustomConfig()" class="flex-1 bg-red-100 text-red-600 py-2 rounded text-xs">Borrar</button>
                </div>
                <button onclick="toggleConfig()" class="text-xs text-gray-400 mt-2 underline w-full text-center">Volver</button>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 z-[60] hidden bg-black/90 flex items-center justify-center p-4" onclick="closeLightbox()">
        <span class="absolute top-5 right-5 text-white text-4xl cursor-pointer">&times;</span>
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl animate__animated animate__zoomIn">
    </div>

    <script>
        const weddingDate = new Date("October 15, 2026 16:00:00").getTime();
        const adminPin = "1234";

        // URL PARAMS
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const guestName = params.get('invitado');
            const guestTickets = params.get('pases');
            if (guestName && guestTickets) {
                document.getElementById('guestNameDisplay').textContent = guestName;
                document.getElementById('guestCountDisplay').textContent = guestTickets;
                document.getElementById('personalTicket').classList.remove('hidden');
                setTimeout(() => document.getElementById('personalTicket').scrollIntoView({ behavior: 'smooth' }), 1000);
            }
        });

        // ADMIN LOGIN & RECONNECT
        function openAdminLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginStatus').classList.add('hidden');
            document.getElementById('loginFormContent').classList.remove('hidden');
            document.getElementById('configPanelContent').classList.add('hidden');
        }

        function toggleConfig() {
            const login = document.getElementById('loginFormContent');
            const config = document.getElementById('configPanelContent');
            if (config.classList.contains('hidden')) {
                login.classList.add('hidden');
                config.classList.remove('hidden');
            } else {
                config.classList.add('hidden');
                login.classList.remove('hidden');
            }
        }

        async function checkLogin() {
            const pass = document.getElementById('adminPassword').value;
            const statusEl = document.getElementById('connectionStatus');
            const errorEl = document.getElementById('loginStatus');
            
            errorEl.classList.add('hidden');

            if (pass === adminPin) {
                // Verificar si Auth está listo
                if (!window.isAuthReady && window.auth && window.auth.currentUser) {
                    window.isAuthReady = true;
                }

                if (!window.isAuthReady) {
                    statusEl.textContent = "Reconectando con la nube...";
                    statusEl.classList.remove('hidden');
                    
                    try {
                        if(window.signInAnonymously && window.auth) {
                            await window.signInAnonymously(window.auth);
                            setTimeout(() => {
                                statusEl.classList.add('hidden');
                                document.getElementById('loginModal').classList.add('hidden');
                                document.getElementById('adminPanel').classList.remove('translate-y-full');
                                loadGuests();
                            }, 1000);
                            return;
                        }
                    } catch (e) {
                        statusEl.innerHTML = "Sin conexión. <br>Intenta configurar tu propia DB en el engrane ⚙️.";
                        return;
                    }
                }

                statusEl.classList.add('hidden');
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('translate-y-full');
                loadGuests(); 
            } else {
                errorEl.textContent = "Contraseña incorrecta";
                errorEl.classList.remove('hidden');
            }
        }

        function closeAdmin() {
            document.getElementById('adminPanel').classList.add('translate-y-full');
        }

        // DATABASE LOAD
        async function loadGuests() {
            if(!window.auth || !window.auth.currentUser) return;

            const q = window.query(
                window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guests'), 
                window.orderBy('createdAt', 'desc')
            );
            
            window.onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('guestTableBody');
                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Sin invitados</td></tr>';
                    return;
                }
                snapshot.forEach((docSnap) => {
                    const guest = docSnap.data();
                    const guestId = docSnap.id;
                    const baseUrl = window.location.origin + window.location.pathname;
                    const personalLink = `${baseUrl}?invitado=${encodeURIComponent(guest.name)}&pases=${guest.tickets}`;
                    const whatsappMsg = `Hola ${guest.name}, aquí tu pase para la boda: ${personalLink}`;
                    const whatsappLink = `https://wa.me/?text=${encodeURIComponent(whatsappMsg)}`;

                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="p-4 font-medium">${guest.name}</td>
                        <td class="p-4 text-center">${guest.tickets}</td>
                        <td class="p-4"><button onclick="navigator.clipboard.writeText('${personalLink}').then(()=>alert('Copiado'))" class="text-blue-500 underline text-xs">Copiar Link</button></td>
                        <td class="p-4 text-center"><button onclick="deleteGuest('${guestId}')" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }, (error) => console.error("Error DB:", error));
        }

        // ADD GUEST
        document.getElementById('addGuestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('inputName').value;
            const tickets = document.getElementById('inputTickets').value;
            if(!window.auth || !window.auth.currentUser) return alert("Sin conexión. Revisa el engrane ⚙️.");

            try {
                await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guests'), {
                    name: name, tickets: parseInt(tickets), createdAt: new Date().toISOString()
                });
                e.target.reset();
            } catch (err) { alert("Error al guardar: " + err.message); }
        });

        // DELETE GUEST
        window.deleteGuest = async (id) => {
            if(confirm('¿Eliminar?')) {
                await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'guests', id));
            }
        };

        // EXPORT EXCEL
        window.exportToExcel = () => {
            const rows = document.querySelectorAll('#guestTableBody tr');
            let csv = "data:text/csv;charset=utf-8,Nombre,Pases\n";
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length > 1) csv += `${cols[0].innerText},${cols[1].innerText}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = "invitados.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // COUNTDOWN & UI
        setInterval(() => {
            const now = new Date().getTime();
            const dist = weddingDate - now;
            const d = Math.floor(dist / (1000 * 60 * 60 * 24));
            const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
            
            const el = document.getElementById("countdown");
            if(el) el.innerHTML = `<span class="text-3xl font-bold">${d}d ${h}h ${m}m</span>`;
        }, 1000);

        // Music & Effects
        const audio = document.getElementById("weddingMusic");
        const musicBtn = document.getElementById("musicBtn");
        let isPlaying = false;
        window.toggleMusic = () => {
            if (isPlaying) { audio.pause(); musicBtn.classList.remove("animate-spin"); }
            else { audio.play(); musicBtn.classList.add("animate-spin"); }
            isPlaying = !isPlaying;
        };

        function reveal() {
            var reveals = document.querySelectorAll(".reveal");
            for (var i = 0; i < reveals.length; i++) {
                if (reveals[i].getBoundingClientRect().top < window.innerHeight - 100) reveals[i].classList.add("active");
            }
        }
        window.addEventListener("scroll", reveal);
        reveal();

        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        window.openLightbox = (src) => { lightboxImg.src = src; lightbox.classList.remove('hidden'); }
        window.closeLightbox = () => { lightbox.classList.add('hidden'); }
        window.sendWhatsapp = () => window.open(`https://wa.me/525512345678?text=Hola,%20confirmo%20asistencia`, '_blank');
        window.addToCalendar = () => window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=Boda&dates=20261015T160000/20261016T020000`, '_blank');
    </script>
</body>
</html>
